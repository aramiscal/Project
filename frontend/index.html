<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shopping List</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <style>
      body {
        background-color: powderblue;
      }
      h1 {
        text-align: center;
        font-size: xx-large;
        font-weight: bold;
      }
      h5 {
        margin-left: auto;
        margin-right: auto;
        max-width: 500px;
        font-size: medium;
      }
      table,
      th,
      td {
        font-size: larger;
      }
      table {
        width: 65%;
        margin-top: 20px;
        border: 5px solid black;
      }
      th {
        border: 2px solid black;
        background-color: lightgray;
      }
      td {
        border: none;
        border-top: 2px;
      }
      th,
      td {
        text-align: center;
        padding: 10px;
      }
      table.center {
        margin-left: auto;
        margin-right: auto;
      }
      p {
        font-size: x-large;
        text-align: center;
      }
      .box {
        width: 500px;
        height: auto;
        border: 3px solid black;
        background-color: lightgray;
        padding: 20px;
        margin: 0 auto;
      }
      #username-display {
        font-weight: bold;
        color: #007bff;
        font-size: 1.1em;
      }
      #signed-in-user {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 0.5rem 1rem !important;
        margin-bottom: 1rem;
      }
      /* Fixed display styles for auth-required elements */
      .auth-required.box {
        display: none; /* Initially hidden */
      }
      .auth-required.box.visible {
        display: block !important; /* Force display when visible class is added */
      }
      table.auth-required {
        display: none; /* Initially hidden */
      }
      table.auth-required.visible {
        display: table !important; /* Force table display when visible */
      }
      .auth-required:not(table):not(.box) {
        display: none; /* Initially hidden */
      }
      .auth-required:not(table):not(.box).visible {
        display: block !important; /* Force block display when visible */
      }

      /* Make sure tables display correctly */
      table.auth-required {
        display: none; /* Initially hidden */
      }

      table.auth-required.visible,
      .authenticated table.auth-required {
        display: table !important; /* Force table display when visible */
        width: 65% !important;
        margin-left: auto !important;
        margin-right: auto !important;
        visibility: visible !important;
      }

      /* Fix for boxes */
      .box.auth-required {
        display: none; /* Initially hidden */
      }

      .box.auth-required.visible,
      .authenticated .box.auth-required {
        display: block !important;
        visibility: visible !important;
      }

      /* Other authenticated elements */
      .auth-required:not(table):not(.box) {
        display: none; /* Initially hidden */
      }

      .auth-required:not(table):not(.box).visible,
      .authenticated .auth-required:not(table):not(.box) {
        display: block !important;
        visibility: visible !important;
      }

      /* Show the signed-in user info when authenticated */
      .authenticated #signed-in-user {
        display: flex !important;
        visibility: visible !important;
      }

      /* Hide auth container when authenticated */
      .authenticated #auth-container {
        display: none !important;
        visibility: hidden !important;
      }

      /* Add authenticated class to body when user is logged in */
      body.authenticated .auth-required {
        display: initial !important;
      }

      body.authenticated table.auth-required {
        display: table !important;
      }

      /* Alert styling for faster alerts */
      #alert-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 350px;
      }

      .alert {
        transition: opacity 0.3s ease-in-out;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 10px;
        opacity: 1;
      }

      .alert.fade {
        opacity: 0;
      }
      @media (max-width: 768px) {
        h5 {
          margin-left: 20px;
          margin-right: 20px;
        }
        .box {
          width: 90%;
        }
        table {
          width: 90%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 class="mt-4 mb-4">Personal Shopping List</h1>

      <hr />

      <!-- Alert Container -->
      <div id="alert-container" class="fixed-top mt-3 me-3"></div>

      <!-- User Info -->
      <div
        id="signed-in-user"
        class="user-info d-flex justify-content-end align-items-center p-2"
        style="display: none"
      >
        <span class="me-2">Welcome</span>
        <span id="username-display" class="fw-bold me-3"></span>
        <button
          id="sign-out-btn"
          class="btn btn-outline-secondary btn-sm ms-2"
          onclick="improvedSignOut()"
        >
          Sign Out
        </button>
      </div>

      <!-- Authentication Container -->
      <div id="auth-container" class="auth-container">
        <h5>
          <ul class="nav nav-tabs" id="auth-tab" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="signin-tab"
                data-bs-toggle="tab"
                data-bs-target="#signin"
                type="button"
                role="tab"
                aria-controls="signin"
                aria-selected="true"
              >
                Sign In
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="signup-tab"
                data-bs-toggle="tab"
                data-bs-target="#signup"
                type="button"
                role="tab"
                aria-controls="signup"
                aria-selected="false"
              >
                Sign Up
              </button>
            </li>
          </ul>
          <div class="tab-content pt-3" id="auth-tab-content">
            <!-- Sign In Form -->
            <div
              class="tab-pane fade show active"
              id="signin"
              role="tabpanel"
              aria-labelledby="signin-tab"
            >
              <form id="sign-in-form">
                <div class="mb-3">
                  <label for="signin-username" class="form-label"
                    >Username</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="signin-username"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="signin-password" class="form-label"
                    >Password</label
                  >
                  <input
                    type="password"
                    class="form-control"
                    id="signin-password"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-primary">Sign In</button>
              </form>
            </div>

            <!-- Sign Up Form -->
            <div
              class="tab-pane fade"
              id="signup"
              role="tabpanel"
              aria-labelledby="signup-tab"
            >
              <form id="sign-up-form">
                <div class="mb-3">
                  <label for="signup-username" class="form-label"
                    >Username</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="signup-username"
                    required
                    autocomplete="username"
                  />
                </div>
                <div class="mb-3">
                  <label for="signup-email" class="form-label">Email</label>
                  <input
                    type="email"
                    class="form-control"
                    id="signup-email"
                    required
                    autocomplete="email"
                  />
                </div>
                <div class="mb-3">
                  <label for="signup-password" class="form-label"
                    >Password</label
                  >
                  <input
                    type="password"
                    class="form-control"
                    id="signup-password"
                    required
                    autocomplete="new-password"
                  />
                  <div class="form-text">
                    Password must be at least 8 characters long.
                  </div>
                </div>
                <div class="mb-3">
                  <label for="signup-confirm-password" class="form-label"
                    >Confirm Password</label
                  >
                  <input
                    type="password"
                    class="form-control"
                    id="signup-confirm-password"
                    required
                    autocomplete="new-password"
                  />
                </div>
                <button
                  type="submit"
                  class="btn btn-primary"
                  onclick="signUp(); return false;"
                >
                  Sign Up
                </button>
              </form>
            </div>
          </div>
        </h5>
      </div>

      <!-- Adding Items Box -->
      <div class="box auth-required mt-4" style="display: none">
        <h4 class="mb-3">Add Items to Your Personal List</h4>
        <div class="input-group mb-3">
          <!-- Input Item -->
          <input
            id="new-name"
            type="text"
            class="form-control"
            placeholder="Item"
            aria-label="Item"
          />
          <span class="input-group-text">#</span>
          <!-- Input Quantity -->
          <input
            id="new-quantity"
            type="number"
            min="1"
            class="form-control"
            placeholder="Quantity"
            aria-label="Quantity"
          />
        </div>
        <div class="input-group mb-3">
          <label class="input-group-text" for="new-type">Type</label>
          <!-- Input Type -->
          <select class="form-select" id="new-type">
            <option selected>Choose...</option>
            <option value="Fruit">Fruit</option>
            <option value="Vegetable">Vegetable</option>
            <option value="Meat">Meat</option>
            <option value="Seafood">Seafood</option>
            <option value="Grain">Grain</option>
            <option value="Dairy">Dairy</option>
          </select>
        </div>
        <div class="input-group mb-3">
          <span class="input-group-text">$</span>
          <!-- Input Price -->
          <input
            id="new-price"
            type="number"
            min="0"
            step="0.01"
            class="form-control"
            placeholder="Price"
            aria-label="Price"
          />
        </div>
        <button id="add-item" type="button" class="btn btn-primary">
          Add Item
        </button>
      </div>

      <!-- Table -->
      <table class="center auth-required mt-4" style="display: none">
        <thead>
          <tr>
            <th scope="col">Item</th>
            <th scope="col">Type</th>
            <th scope="col">Quantity</th>
            <th scope="col">Price in $</th>
            <th scope="col"></th>
          </tr>
        </thead>
        <tbody id="list-rows"></tbody>
      </table>

      <div class="auth-required mt-3" style="display: none">
        <p>
          <b>Your Total: $</b>
          <span id="update-price">0</span>
        </p>
      </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>
    <script src="auth.js"></script>
    <script src="main.js"></script>

    <!-- Direct UI Control Script -->
    <script>
      // Direct approach to change UI after sign-in
      function forceShowShoppingUI() {
        console.log("FORCING UI CHANGE: Showing shopping list UI");

        // Hide auth container with !important
        const authContainer = document.getElementById("auth-container");
        if (authContainer) {
          authContainer.style.display = "none";
          authContainer.style.visibility = "hidden"; // Add extra hiding
          console.log("Auth container forcibly hidden");
        }

        // Show all shopping list elements with appropriate display
        const boxElements = document.querySelectorAll(".box.auth-required");
        boxElements.forEach((el) => {
          el.style.display = "block";
          el.style.visibility = "visible";
          console.log("Shopping list box displayed");
        });

        // Tables need display:table
        const tableElements = document.querySelectorAll("table.auth-required");
        tableElements.forEach((el) => {
          el.style.display = "table";
          el.style.visibility = "visible";
          console.log("Shopping list table displayed");
        });

        // Other elements need display:block
        const otherElements = document.querySelectorAll(
          ".auth-required:not(table):not(.box)"
        );
        otherElements.forEach((el) => {
          el.style.display = "block";
          el.style.visibility = "visible";
          console.log("Other shopping list elements displayed");
        });

        // Show user info
        const signedInUser = document.getElementById("signed-in-user");
        if (signedInUser) {
          signedInUser.style.display = "block";
          signedInUser.style.visibility = "visible";
          console.log("User info displayed");
        }

        // Try to load shopping list data
        setTimeout(function () {
          if (typeof window.getList === "function") {
            window.getList();
            console.log("Attempting to load shopping list data");
          } else if (typeof getList === "function") {
            getList();
            console.log("Attempting to load shopping list data");
          } else {
            console.warn("getList function not available");
          }
        }, 500);
      }

      // Direct override of the sign-in form submission
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Setting up direct form submission handler");

        const signInForm = document.getElementById("sign-in-form");
        if (signInForm) {
          // Replace existing handlers with our direct one
          signInForm.addEventListener(
            "submit",
            function (e) {
              e.preventDefault();

              const username = document.getElementById("signin-username").value;
              const password = document.getElementById("signin-password").value;

              console.log(
                "Direct sign-in handler: Attempting login for",
                username
              );

              // Use FormData for the request
              const formData = new FormData();
              formData.append("username", username);
              formData.append("password", password);

              // Create and send request
              const xhr = new XMLHttpRequest();
              xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                  if (xhr.status === 200) {
                    try {
                      const response = JSON.parse(xhr.responseText);

                      // Store authentication data
                      localStorage.setItem(
                        "access_token",
                        response.access_token
                      );
                      localStorage.setItem("username", username);

                      console.log("Login successful! Forcing UI change");

                      // Make sure the username is displayed
                      if (typeof window.enhanceUsernameDisplay === "function") {
                        window.enhanceUsernameDisplay();
                      } else {
                        // Fallback if enhanced function isn't available
                        const usernameDisplay =
                          document.getElementById("username-display");
                        if (usernameDisplay) {
                          usernameDisplay.textContent = username;
                        }

                        // Make sure the user info container is shown
                        const signedInUser =
                          document.getElementById("signed-in-user");
                        if (signedInUser) {
                          signedInUser.style.display = "flex";
                        }
                      }

                      // Add a small delay to ensure DOM updates
                      setTimeout(forceShowShoppingUI, 100);

                      // Show success message
                      const alertContainer =
                        document.getElementById("alert-container");
                      if (alertContainer) {
                        // Use quick alert if available
                        if (typeof window.quickAlert === "function") {
                          window.quickAlert(
                            `Welcome back, ${username}!`,
                            "success"
                          );
                        } else {
                          const alert = document.createElement("div");
                          alert.className =
                            "alert alert-success alert-dismissible fade show";
                          alert.innerHTML = `Welcome back, ${username}! <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
                          alertContainer.appendChild(alert);

                          // Auto dismiss anyway
                          setTimeout(() => {
                            try {
                              alertContainer.removeChild(alert);
                            } catch (e) {
                              // Already removed
                            }
                          }, 2000);
                        }
                      }
                    } catch (e) {
                      console.error("Error processing login response:", e);
                      alert("Error logging in. Please try again.");
                    }
                  } else {
                    console.error("Login failed with status:", xhr.status);
                    alert("Login failed. Please check your credentials.");
                  }
                }
              };

              xhr.open("POST", "/users/sign-in", true);
              xhr.send(formData);
            },
            true
          ); // Use capture to ensure our handler runs first

          console.log("Direct form submission handler installed");
        } else {
          console.error("Could not find sign-in form!");
        }

        // Check if already logged in
        if (localStorage.getItem("access_token")) {
          console.log("User already logged in, forcing UI update");
          setTimeout(forceShowShoppingUI, 100);
        }
      });

      // Expose the function globally
      window.forceShowShoppingUI = forceShowShoppingUI;

      // Add direct click handler to sign-in button
      document.addEventListener("DOMContentLoaded", function () {
        // Add click handler to sign-in button
        const signInButton = document.querySelector(
          '#sign-in-form button[type="submit"]'
        );
        if (signInButton) {
          signInButton.onclick = function (e) {
            e.preventDefault();
            // Get form
            const form = document.getElementById("sign-in-form");
            // Trigger submit event
            if (form) {
              const event = new Event("submit", {
                bubbles: true,
                cancelable: true,
              });
              form.dispatchEvent(event);
            }
          };
        }

        // Add click handler to sign-out button
        const signOutButton = document.getElementById("sign-out-btn");
        if (signOutButton) {
          signOutButton.onclick = function (e) {
            e.preventDefault();
            console.log("Sign-out button clicked (direct handler)");

            // Clear auth data
            localStorage.removeItem("access_token");
            localStorage.removeItem("username");

            // Show auth UI
            const authContainer = document.getElementById("auth-container");
            if (authContainer) {
              authContainer.style.display = "block";
              authContainer.style.visibility = "visible";
            }

            // Hide shopping list UI
            document.querySelectorAll(".auth-required").forEach(function (el) {
              el.style.display = "none";
            });

            // Hide user info
            const userInfo = document.getElementById("signed-in-user");
            if (userInfo) {
              userInfo.style.display = "none";
            }

            // Show success message
            const alertContainer = document.getElementById("alert-container");
            if (alertContainer) {
              const alert = document.createElement("div");
              alert.className = "alert alert-info alert-dismissible fade show";
              alert.innerHTML =
                'You have been signed out successfully. <button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
              alertContainer.appendChild(alert);
            }

            // If we have an improved function, call it too
            if (typeof window.improvedSignOut === "function") {
              window.improvedSignOut();
            }
          };
        }
      });
    </script>
    <!-- Quick Alert Script -->
    <script>
      // Enhanced function to show alerts that disappear faster
      function quickAlert(message, type = "info") {
        const alertContainer = document.getElementById("alert-container");
        if (!alertContainer) {
          console.error("Alert container not found!");
          return;
        }

        const alert = document.createElement("div");
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.role = "alert";
        alert.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

        alertContainer.appendChild(alert);

        // Make alerts disappear quickly (after 2 seconds instead of default)
        setTimeout(() => {
          alert.classList.remove("show");
          alert.classList.add("fade");

          // Remove from DOM after fade animation (300ms)
          setTimeout(() => {
            try {
              alertContainer.removeChild(alert);
            } catch (e) {
              // Alert might have been removed by another method
              console.log("Alert already removed");
            }
          }, 300);
        }, 2000); // 2 seconds display time
      }

      // Make quickAlert globally available
      window.quickAlert = quickAlert;

      // Override the existing showAlert function if it exists
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Setting up quick alerts");

        // Override global showAlert
        window.showAlert = quickAlert;

        // Override auth.showAlert if it exists
        if (window.auth && typeof window.auth.showAlert === "function") {
          window.auth.showAlert = quickAlert;
        }
      });
    </script>

    <!-- MongoDB Connection Script -->
    <script>
      // Wait for DOM to be fully loaded
      document.addEventListener("DOMContentLoaded", function () {
        // Get the sign up form
        const signUpForm = document.getElementById("sign-up-form");

        if (signUpForm) {
          // Prevent the default form submission and call our signUp function instead
          signUpForm.addEventListener("submit", function (event) {
            event.preventDefault();
            // Call the signUp function which will handle MongoDB integration
            signUp();
          });
        } else {
          console.error("Sign up form not found!");
        }
      });
    </script>

    <!-- Username Display Enhancement Script -->
    <script>
      // Improved function to ensure username is displayed next to "Welcome"
      function enhanceUsernameDisplay() {
        console.log("Enhancing username display");

        // Get username from localStorage
        const username = localStorage.getItem("username");

        // Get the username display element
        const usernameDisplay = document.getElementById("username-display");

        if (username && usernameDisplay) {
          // Set the username text
          usernameDisplay.textContent = username;
          console.log("Username display updated to:", username);

          // Make sure the signed-in user container is visible
          const signedInUser = document.getElementById("signed-in-user");
          if (signedInUser) {
            signedInUser.style.display = "flex"; // Using flex for proper alignment
            console.log("Signed-in user info container made visible");
          }
        } else {
          console.warn(
            "Username not displayed:",
            username
              ? "Username found in storage"
              : "Username not found in storage",
            usernameDisplay
              ? "Display element found"
              : "Display element not found"
          );
        }
      }

      // Call this function after successful sign-in
      document.addEventListener("DOMContentLoaded", function () {
        console.log("DOM loaded, checking for username display");

        // Check if user is logged in
        const token = localStorage.getItem("access_token");
        if (token) {
          console.log("User appears to be logged in, showing username");
          enhanceUsernameDisplay();

          // Also override the existing updateUsernameDisplay function if it exists
          if (typeof window.updateUsernameDisplay === "function") {
            console.log("Overriding existing updateUsernameDisplay function");
            window.updateUsernameDisplay = enhanceUsernameDisplay;
          }
        }

        // Make this function run after a successful sign-in
        const original_signIn = window.signIn;
        if (typeof original_signIn === "function") {
          window.signIn = function () {
            const result = original_signIn.apply(this, arguments);
            if (result && result.then) {
              result.then(function () {
                enhanceUsernameDisplay();
              });
            }
            return result;
          };
        }

        // Also make sure our forceShowShoppingUI function calls enhanceUsernameDisplay
        const original_forceShowShoppingUI = window.forceShowShoppingUI;
        if (typeof original_forceShowShoppingUI === "function") {
          window.forceShowShoppingUI = function () {
            original_forceShowShoppingUI.apply(this, arguments);
            enhanceUsernameDisplay();
          };
        }
      });

      // Make the function available globally
      window.enhanceUsernameDisplay = enhanceUsernameDisplay;
    </script>

    <!-- Sign Out Script -->
    <script>
      // Enhanced Sign Out function
      function improvedSignOut() {
        console.log("Sign out initiated");

        // Clear authentication data from localStorage
        localStorage.removeItem("access_token");
        localStorage.removeItem("username");

        // Show the authentication UI
        const authContainer = document.getElementById("auth-container");
        if (authContainer) {
          authContainer.style.display = "block";
          authContainer.style.visibility = "visible";
          console.log("Auth container shown");
        } else {
          console.error("Auth container not found!");
        }

        // Hide the signed-in user display
        const signedInUser = document.getElementById("signed-in-user");
        if (signedInUser) {
          signedInUser.style.display = "none";
          console.log("Signed-in user info hidden");
        }

        // Clear the shopping list in the UI
        const listRows = document.getElementById("list-rows");
        if (listRows) {
          listRows.innerHTML = "";
          console.log("Shopping list cleared");
        }

        // Reset the total price
        const totalPrice = document.getElementById("update-price");
        if (totalPrice) {
          totalPrice.textContent = "0";
          console.log("Total price reset");
        }

        // Hide all elements that require authentication
        const tableElements = document.querySelectorAll("table.auth-required");
        tableElements.forEach((element) => {
          element.style.display = "none";
          console.log("Table element hidden");
        });

        const boxElements = document.querySelectorAll(".box.auth-required");
        boxElements.forEach((element) => {
          element.style.display = "none";
          console.log("Box element hidden");
        });

        const otherAuthElements = document.querySelectorAll(
          ".auth-required:not(table):not(.box)"
        );
        otherAuthElements.forEach((element) => {
          element.style.display = "none";
          console.log("Other auth element hidden");
        });

        // Reset input fields
        const nameInput = document.getElementById("new-name");
        const quantityInput = document.getElementById("new-quantity");
        const typeInput = document.getElementById("new-type");
        const priceInput = document.getElementById("new-price");

        if (nameInput) nameInput.value = "";
        if (quantityInput) quantityInput.value = "";
        if (typeInput) typeInput.value = "Choose...";
        if (priceInput) priceInput.value = "";
        console.log("Input fields reset");

        // Show a success message
        quickAlert("You have been signed out successfully.", "info");
      }

      // Connect the sign-out button to our improved function
      document.addEventListener("DOMContentLoaded", function () {
        const signOutBtn = document.getElementById("sign-out-btn");
        if (signOutBtn) {
          // Remove any existing event listeners
          const newBtn = signOutBtn.cloneNode(true);
          signOutBtn.parentNode.replaceChild(newBtn, signOutBtn);

          // Add our improved sign-out function
          newBtn.addEventListener("click", function (e) {
            e.preventDefault();
            console.log("Sign-out button clicked");
            improvedSignOut();
          });
          console.log("Improved sign-out function connected to button");
        } else {
          console.warn("Sign-out button not found");
        }
      });

      // Also override any existing signOut functions
      window.signOut = improvedSignOut;

      // In case there's a handleSignOut function
      window.handleSignOut = improvedSignOut;

      // In case there's an auth object with signOut
      if (window.auth && typeof window.auth.signOut === "function") {
        window.auth.signOut = improvedSignOut;
      }
    </script>

    <!-- Quick Alert Script -->
    <script>
      // Enhanced function to show alerts that disappear faster
      function quickAlert(message, type = "info") {
        const alertContainer = document.getElementById("alert-container");
        if (!alertContainer) {
          console.error("Alert container not found!");
          return;
        }

        const alert = document.createElement("div");
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.role = "alert";
        alert.innerHTML = `
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        alertContainer.appendChild(alert);

        // Make alerts disappear quickly (after 2 seconds instead of default)
        setTimeout(() => {
          alert.classList.remove("show");
          alert.classList.add("fade");

          // Remove from DOM after fade animation (300ms)
          setTimeout(() => {
            try {
              alertContainer.removeChild(alert);
            } catch (e) {
              // Alert might have been removed by another method
              console.log("Alert already removed");
            }
          }, 300);
        }, 2000); // 2 seconds display time
      }

      // Override the existing showAlert function if it exists
      document.addEventListener("DOMContentLoaded", function () {
        console.log("Setting up quick alerts");

        // Override global showAlert
        window.showAlert = quickAlert;

        // Override auth.showAlert if it exists
        if (window.auth && typeof window.auth.showAlert === "function") {
          window.auth.showAlert = quickAlert;
        }
      });
    </script>
    <!-- Add this before the closing body tag -->
    <script>
      // Simple fix for add item functionality
      document.addEventListener('DOMContentLoaded', function() {
        console.log('Direct fix script loaded');
        
        // Fix the add item button
        const addItemBtn = document.getElementById('add-item');
        if (addItemBtn) {
          console.log('Add item button found, adding fixed handler');
          
          // Replace existing handlers with our fixed version
          addItemBtn.onclick = function(e) {
            e.preventDefault();
            console.log('Add item button clicked (fixed handler)');
            
            // Get input values
            const nameInput = document.getElementById("new-name");
            const quantityInput = document.getElementById("new-quantity");
            const typeInput = document.getElementById("new-type");
            const priceInput = document.getElementById("new-price");
            
            if (!nameInput || !quantityInput || !typeInput || !priceInput) {
              alert('Could not find input elements');
              return;
            }
            
            const name = nameInput.value.trim();
            const quantity = quantityInput.value.trim();
            const type = typeInput.value;
            const price = priceInput.value.trim();
            
            // Check if all required fields are filled
            if (!name || !quantity || type === "Choose..." || !price) {
              alert('All fields are required');
              return;
            }
            
            const quantityToInt = parseInt(quantity, 10);
            const priceToFloat = parseFloat(price);
            
            // Validate numeric values
            if (isNaN(quantityToInt) || quantityToInt <= 0) {
              alert('Quantity must be a positive number');
              return;
            }
            
            if (isNaN(priceToFloat) || priceToFloat <= 0) {
              alert('Price must be a positive number');
              return;
            }
            
            // Make sure we have a token
            const token = localStorage.getItem('access_token');
            if (!token) {
              alert('You must be logged in to add items');
              return;
            }
            
            // Send direct fetch request
            fetch('/list', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
              },
              body: JSON.stringify({
                name: name,
                type: type,
                quantity: quantityToInt,
                price: priceToFloat
              })
            })
            .then(response => {
              if (!response.ok) {
                throw new Error('Server error: ' + response.status);
              }
              return response.json();
            })
            .then(data => {
              alert('Item added successfully!');
              
              // Reset input fields
              nameInput.value = '';
              quantityInput.value = '';
              typeInput.value = 'Choose...';
              priceInput.value = '';
              
              // Reload the page to refresh the list
              location.reload();
            })
            .catch(error => {
              alert('Error adding item: ' + error.message);
            });
          };
          
          console.log('Fixed handler attached');
        }
      });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        console.log('Table update fix loaded');
        
        // Improve Add Item functionality
        const addItemBtn = document.getElementById('add-item');
        if (addItemBtn) {
          addItemBtn.onclick = function(e) {
            e.preventDefault();
            
            // Get input values
            const nameInput = document.getElementById("new-name");
            const quantityInput = document.getElementById("new-quantity");
            const typeInput = document.getElementById("new-type");
            const priceInput = document.getElementById("new-price");
            
            if (!nameInput || !quantityInput || !typeInput || !priceInput) {
              alert('Could not find input elements');
              return;
            }
            
            const name = nameInput.value.trim();
            const quantity = quantityInput.value.trim();
            const type = typeInput.value;
            const price = priceInput.value.trim();
            
            // Basic validation
            if (!name || !quantity || type === "Choose..." || !price) {
              alert('All fields are required');
              return;
            }
            
            const token = localStorage.getItem('access_token');
            if (!token) {
              alert('You must be logged in to add items');
              return;
            }
            
            // Send request
            fetch('/list', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
              },
              body: JSON.stringify({
                name: name,
                type: type,
                quantity: parseInt(quantity),
                price: parseFloat(price)
              })
            })
            .then(response => response.json())
            .then(data => {
              // Reset inputs
              nameInput.value = '';
              quantityInput.value = '';
              typeInput.value = 'Choose...';
              priceInput.value = '';
              
              // Fetch updated list
              fetchAndDisplayList();
            })
            .catch(error => {
              alert('Error: ' + error.message);
            });
          };
        }
        
        // Function to fetch and display list
        function fetchAndDisplayList() {
          const token = localStorage.getItem('access_token');
          if (!token) return;
          
          fetch('/list', {
            headers: {
              'Authorization': 'Bearer ' + token
            }
          })
          .then(response => response.json())
          .then(items => {
            const tbody = document.getElementById("list-rows");
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (items.length === 0) {
              tbody.innerHTML = '<tr><td colspan="5" class="text-center">No items in your personal list</td></tr>';
              updateTotal([]);
              return;
            }
            
            // Sort by type
            items.sort((a, b) => a.type.localeCompare(b.type));
            
            // Create rows
            items.forEach(item => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${item.name}</td>
                <td>${item.type}</td>
                <td>${item.quantity}</td>
                <td>${item.price.toFixed(2)}</td>
                <td><button type="button" class="btn btn-danger" data-name="${item.name}">Delete</button></td>
              `;
              tbody.appendChild(row);
            });
            
            // Add delete handlers
            document.querySelectorAll('#list-rows button.btn-danger').forEach(btn => {
              btn.onclick = function() {
                deleteItem(this.getAttribute('data-name'));
              };
            });
            
            // Update total
            updateTotal(items);
          })
          .catch(error => {
            console.error('Error fetching list:', error);
          });
        }
        
        // Update total price
        function updateTotal(items) {
          const totalEl = document.getElementById('update-price');
          if (!totalEl) return;
          
          const total = items.reduce((sum, item) => sum + item.price, 0);
          totalEl.textContent = total.toFixed(2);
        }
        
        // Delete item function
        function deleteItem(name) {
          if (!name) return;
          
          const token = localStorage.getItem('access_token');
          if (!token) return;
          
          fetch(`/list/${name}`, {
            method: 'DELETE',
            headers: {
              'Authorization': 'Bearer ' + token
            }
          })
          .then(response => {
            if (response.ok) {
              fetchAndDisplayList();
            } else {
              alert('Error deleting item');
            }
          })
          .catch(error => {
            alert('Error: ' + error.message);
          });
        }
        
        // Initial load
        if (localStorage.getItem('access_token')) {
          fetchAndDisplayList();
        }
      });
    </script>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        console.log('Auth fix script loaded');
        
        // Fix authentication issues
        function fixAuth() {
          // Check if token is available
          const token = localStorage.getItem('access_token');
          if (!token) {
            console.log('No auth token found');
            return;
          }
          
          console.log('Token found, setting up automatic auth for requests');
          
          // Add token to ALL fetch requests
          const originalFetch = window.fetch;
          window.fetch = function(url, options = {}) {
            // Create new options object with authorization
            const newOptions = {...options};
            newOptions.headers = {...(options.headers || {})};
            
            // Only add token if not already present
            if (!newOptions.headers['Authorization']) {
              newOptions.headers['Authorization'] = `Bearer ${token}`;
            }
            
            // Call original fetch with new options
            return originalFetch(url, newOptions);
          };
          
          // Try to get the list
          setTimeout(() => {
            fetchAndUpdateList();
          }, 500);
        }
        
        // Fetch and update list
        function fetchAndUpdateList() {
          fetch('/list')
            .then(response => {
              if (!response.ok) throw new Error(`Status ${response.status}`);
              return response.json();
            })
            .then(items => updateTableDisplay(items))
            .catch(err => console.error('Error fetching list:', err));
        }
        
        // Update table display
        function updateTableDisplay(items) {
          const tbody = document.getElementById('list-rows');
          if (!tbody) return;
          
          // Clear table
          tbody.innerHTML = '';
          
          if (!items || items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">No items in your list</td></tr>';
            updateTotal(0);
            return;
          }
          
          // Add items to table
          items.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${item.name || ''}</td>
              <td>${item.type || ''}</td>
              <td>${item.quantity || 0}</td>
              <td>${typeof item.price === 'number' ? item.price.toFixed(2) : '0.00'}</td>
              <td><button type="button" class="btn btn-danger" onclick="deleteItem('${item.name}')">Delete</button></td>
            `;
            tbody.appendChild(row);
          });
          
          // Update total
          const total = items.reduce((sum, item) => sum + (item.price || 0), 0);
          updateTotal(total);
        }
        
        // Update total display
        function updateTotal(total) {
          const totalElement = document.getElementById('update-price');
          if (totalElement) {
            totalElement.textContent = typeof total === 'number' ? total.toFixed(2) : '0.00';
          }
        }
        
        // Initialize fix
        fixAuth();
      });
    </script>
    <script>
      // Add this helper function to manage the authenticated class on the body
      function updateBodyClass() {
        if (localStorage.getItem("access_token")) {
          document.body.classList.add("authenticated");
        } else {
          document.body.classList.remove("authenticated");
        }
      }
      
      // Check on page load
      document.addEventListener("DOMContentLoaded", function() {
        updateBodyClass();
        
        // Check authentication state and apply appropriate UI
        if (typeof window.checkAuthState === "function") {
          window.checkAuthState();
        }
      });
      
      // Update when auth state changes
      window.addEventListener("storage", function(e) {
        if (e.key === "access_token") {
          updateBodyClass();
        }
      });
      
      // Also check periodically
      setInterval(updateBodyClass, 2000);
    </script>
  </body>
</html>
